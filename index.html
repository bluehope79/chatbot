<!doctype html>
<html>
  <head>
    <title>Socket.IO chat</title>
        <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font: 13px Helvetica, Arial; }
      form { background: #000; padding: 3px; position: fixed; bottom: 0; width: 100%; }
      form input { border: 0; padding: 10px; width: 90%; margin-right: .5%; }
      form button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }
	  #userList {border-radius:4px;left:70%;background: rgb(130, 224, 255); padding: 3px; position: fixed; top: 0px; width: 100%;}
      #messages { list-style-type: none; margin: 0; padding: 0; }
      #messages li { padding: 5px 10px; }
      #messages li:nth-child(even) { background-color : darkgray; padding:6px 10px; width:50%; height: auto;style="font-weight:bold"; font-size:14pt; border-radius:10px;word-break:break-all;}
      #messages { margin-bottom: 40px }
	  #birong1 {text-align: right !important;}
	  #birong2 {background: rgb(255, 255, 255) !important; text-align: right !important;    display:inline-block!important;width:25% !important;}
	  #birong3 {background: rgb(130, 224, 255) !important; text-align: right !important;    display:inline-block !important; width:50% !important;}
	  
     .setDiv {padding-top: 0px; text-align: center;}
      .mask {position:absolute;left:0;top:0;z-index:9999;background-color:#000;display:none;}
      .window {display: none;background-color: #ffffff;height: 220px;z-index:99999;}
      .close {
         width:320px;
         background-color: #09c6d2;
         border: none;
         color:#fff;
         padding: 15px 0;
         text-align: center;
         text-decoration: none;
         display: inline-block;
         font-size: 15px;
         margin: 4px;
         cursor: pointer;
      }
      input[type=text]{
         width: 320px;
         padding: 12px 25px;
         margin: 4px;
         display: inline-block;
         border: 1px solid #ccc;
         border-radius: 4px;
         box-sizing: border-box;
      }
      .window h2 {padding:13px 24px;min-height:7px;color:#ffffff;font-size:14px;background:#09c6d2;}
      .window {border:2px solid #09c6d2;}
      .tmText {margin-top:10px;margin-bottom:20px;margin-left:10px; margin-right:10px;color:#8a8a8a;font-size:12px;}
      h4{
         color: darkGray;
         text-align:left;
         margin-left : 16px;
         margin-top : 8px;
         margin-bottom : 4px;
      }
    </style>
   
    <div class="setDiv">
      <div class="mask"></div>
      <div class="window">
          <h2>대화명 설정</h2>
          <h4>대화명</h4>
         <input id="username" name="username" type="text"> <p>
         <input type="button" href="#" class="close" value="입장하기"/>
         <p class="tmText">한글 1~6자, 영문 대소문자, 숫자 2~12자를 사용할 수 있습니다.</p>
      </div>
   </div>
    <div id="userList"><li>fewfew</li></div>
  </head>
  <body>
    <ul id="messages"></ul>
    <form action="">
      <input id="m" autocomplete="off" /><button>Send</button>
    </form>
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script type="text/javascript">
      $(function () {
        var socket = io();
      var chec = 0;
      var typing = false;
      var timeout;
      <!--핫솔이코드추가-->
      function wrapWindowByMask(){
         var maskHeight = $(document).height();
         var maskWidth = $(window).width();
         $('.mask').css({'width':maskWidth,'height':maskHeight});
         $('.mask').fadeIn(1000);
         $('.mask').fadeTo("slow",0.8);
         var left = ( $(window).scrollLeft() + ( $(window).width() - $('.window').width()) / 2 );
         var top = ( $(window).scrollTop() + ( $(window).height() - $('.window').height()) / 2 );
         $('.window').css({'left':left,'top':top, 'position':'absolute'});
         $('.window').show();
       }
      wrapWindowByMask();
      <!--핫솔이 코드추가끝-->
      
      
      <!-- 키보드 입력시 typing 값을 true로 바꾸고 이를 서버에 알려준다 0.5초동안 입력이 없을 시 타임아웃발생-->
      $('#m').keyup(function() {
         typing=true;
         if($('#m').val() == ''){socket.emit('typing', false);}
         else{socket.emit('typing', typing);}
      });
      <!-- 자기 자신의 메시지는 메시지보낼시 먼저 append시켜준다 -->
      $('form').submit(function(){
       socket.emit('typing', false);     
         var mymsg = $('#m').val();
         if(mymsg!= ''){
            $('#messages').append($('<li>').text('나'));             // 나중에 고친다. append
            $('#messages').append($('<li>').text(mymsg));
            window.scrollTo(0, document.body.scrollHeight);
            socket.emit('chat message', mymsg);
            $('#m').val('');
            <!--다시 커서 채팅창으로-->
            $('#m').focus();
            return false;
         }
         else{
         $('#m').focus();   /// 나중에 추가!!
         return false;
         }
        });                     
      <!--핫솔이 코드추가-->  
      $('.window .close').click(function (e) {
         e.preventDefault();
       if($('#username').val() != ''){
         socket.emit('new user', $('#username').val(), function(data) {
            if (data) {
         chec = 1;
               $('.mask, .window').hide();
            } 
            else if(!data) 
         {alert("이미 있는 닉네임 입니다.");}
         });
       }
       else
         alert("닉네임을 입력해 주세요");
      });
     <!--핫솔이 코드추가끝-->
     
        socket.on('chat message', function(msg, name){
        if(chec == 0) return false;
		if(name === '비룡'){
			$('#messages').append($("<li id='birong1'>").text(name));
			$('#messages').append($("<li id='birong2'>"));
			$('#messages').append($("<li id='birong2'>"));
			$('#messages').append($("<li id='birong3'>").text(msg));
		}
        else{$('#messages').append($('<li>').text(name));
        $('#messages').append($('<li>').text(msg));
		}
        window.scrollTo(0, document.body.scrollHeight);
        });
      
    <!-- 리스트 출력-->
      socket.on('usernames', function(data){
	   $('#userList').text('');
		var i;
         for (i = 0 ; i < data.userList.length;i++) {
            $('#userList').append($('<li>').text(data.userList[i]));
         }
        });
      
      <!-- 서버로 부터 typing 메시지의 data가 false가 아닐시 유저가 타이핑 중이라는 글 출력-->
      socket.on('typing', function(data){
			var i, j;
			$('#userList').text('');
			for( i = 0 ; i < data.userList.length;i++){
				var na = data.userList[i];
				var c = false;
				for(j = 0; j < data.typingList.length;j++){
					var k = na.indexOf(data.typingList[j]);
					if(k == 0) {c = true;}
					//$('#userList').append($('<li>').text(data.userList[i]+'  '+data.typingList[j]+'   '+k));
				}
				if( c == true){ //타이핑 리스트에 있을때
					 $('#userList').append($('<li>').text(data.userList[i]+' is typing....'));
				}
				else{ // 타이핑 리스트에 없을 때
					$('#userList').append($('<li>').text(data.userList[i]));
				}
			}
			
      });

      });
    </script>
  </body>
</html>